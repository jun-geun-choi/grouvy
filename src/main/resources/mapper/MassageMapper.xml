<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.example.grouvy.message.mapper.MessageMapper">

    <resultMap id="messageResultMap" type="com.example.grouvy.message.vo.Message">
        <id property="messageId" column="MESSAGE_ID"/>
        <result property="senderId" column="SENDER_ID"/>
        <result property="subject" column="SUBJECT"/>
        <result property="messageContent" column="MESSAGE_CONTENT"/>
        <result property="sendDate" column="SEND_DATE"/>
        <result property="recallAble" column="RECALL_ABLE"/>
        <!-- 보낸 쪽지함 조회를 위해 sendId 추가 -->
        <result property="sendId" column="SEND_ID"/>
    </resultMap>

    <resultMap id="messageReceiverResultMap" type="com.example.grouvy.message.vo.MessageReceiver">
        <id property="receiveId" column="RECEIVE_ID"/>
        <result property="messageId" column="MESSAGE_ID"/>
        <result property="receiverId" column="RECEIVER_ID"/>
        <result property="receiverType" column="RECEIVER_TYPE"/>
        <result property="readDate" column="READ_DATE"/>
        <result property="inboxStatus" column="INBOX_STATUS"/>
        <result property="isDeleted" column="IS_DELETED"/>
        <result property="importantYn" column="IMPORTANT_YN"/>
        <!-- 조인된 필드 -->
        <result property="senderName" column="SENDER_NAME"/>
        <result property="subject" column="SUBJECT"/>
        <result property="sendDate" column="SEND_DATE"/>
    </resultMap>

    <resultMap id="messageSenderResultMap" type="com.example.grouvy.message.vo.MessageSender">
        <id property="sendId" column="SEND_ID"/>
        <result property="messageId" column="MESSAGE_ID"/>
        <result property="senderId" column="SENDER_ID"/>
        <result property="isDeleted" column="IS_DELETED"/>
    </resultMap>

    <!-- 쪽지 발송 관련 쿼리 (기존) -->
    <insert id="insertMessage" parameterType="com.example.grouvy.message.vo.Message" useGeneratedKeys="true"
            keyProperty="messageId">
        <selectKey keyProperty="messageId" resultType="long" order="BEFORE">
            SELECT MESSAGES_MESSAGE_ID_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO GROUVY_MESSAGES (
        MESSAGE_ID, SENDER_ID, SUBJECT, MESSAGE_CONTENT, SEND_DATE, RECALL_ABLE
        ) VALUES (
        #{messageId}, #{senderId}, #{subject}, #{messageContent}, SYSDATE, #{recallAble}
        )
    </insert>

    <insert id="insertMessageSender" parameterType="com.example.grouvy.message.vo.MessageSender" useGeneratedKeys="true"
            keyProperty="sendId">
        <selectKey keyProperty="sendId" resultType="long" order="BEFORE">
            SELECT MESSAGE_SEND_SEND_ID_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO GROUVY_MESSAGE_SEND (
        SEND_ID, MESSAGE_ID, SENDER_ID, IS_DELETED
        ) VALUES (
        #{sendId}, #{messageId}, #{senderId}, #{isDeleted}
        )
    </insert>

    <insert id="insertMessageReceiver" parameterType="com.example.grouvy.message.vo.MessageReceiver"
            useGeneratedKeys="true" keyProperty="receiveId">
        <selectKey keyProperty="receiveId" resultType="long" order="BEFORE">
            SELECT MESSAGE_RECEIVE_RECEIVE_ID_SEQ.NEXTVAL FROM DUAL
        </selectKey>
        INSERT INTO GROUVY_MESSAGE_RECEIVE (
        RECEIVE_ID, MESSAGE_ID, RECEIVER_ID, RECEIVER_TYPE, READ_DATE, INBOX_STATUS, IS_DELETED, IMPORTANT_YN
        ) VALUES (
        #{receiveId},
        #{messageId},    <!-- **이 부분이 누락되었습니다. 정확히 다시 추가합니다.** -->
        #{receiverId},
        #{receiverType},
        #{readDate, jdbcType=DATE}, <!-- 이제 8개의 파라미터가 모두 올바른 위치에 있습니다. -->
        #{inboxStatus},
        #{isDeleted},
        #{importantYn}
        )
    </insert>

    <!-- **새로 추가될 쪽지 목록 조회 및 상세 보기 관련 쿼리** -->

    <!-- findReceivedMessagesByReceiverIdPaginated: 받은 쪽지함 페이징 조회 -->
    <select id="findReceivedMessagesByReceiverIdPaginated" resultMap="messageReceiverResultMap">
        SELECT
        mr.RECEIVE_ID,
        mr.MESSAGE_ID,
        mr.RECEIVER_ID,
        mr.RECEIVER_TYPE,
        mr.READ_DATE,
        mr.INBOX_STATUS,
        mr.IS_DELETED,
        mr.IMPORTANT_YN,
        m.SUBJECT,
        u.NAME AS SENDER_NAME, <!-- GROUVY_USERS의 NAME 컬럼을 SENDER_NAME으로 별칭 -->
        m.SEND_DATE
        FROM
        GROUVY_MESSAGE_RECEIVE mr
        JOIN
        GROUVY_MESSAGES m ON mr.MESSAGE_ID = m.MESSAGE_ID
        JOIN
        GROUVY_USERS u ON m.SENDER_ID = u.USER_ID
        WHERE
        mr.RECEIVER_ID = #{receiverId}
        AND mr.IS_DELETED = 'N'
        AND mr.INBOX_STATUS != 'RECALLED_BY_SENDER'
        ORDER BY
        m.SEND_DATE DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- countTotalReceivedMessages: 받은 쪽지함 총 항목 수 -->
    <select id="countTotalReceivedMessages" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM GROUVY_MESSAGE_RECEIVE mr
                 JOIN
             GROUVY_MESSAGES m ON mr.MESSAGE_ID = m.MESSAGE_ID
        WHERE mr.RECEIVER_ID = #{receiverId}
          AND mr.IS_DELETED = 'N'
          AND mr.INBOX_STATUS != 'RECALLED_BY_SENDER'
    </select>

    <!-- findImportantMessagesByReceiverIdPaginated: 중요 쪽지함 페이징 조회 -->
    <select id="findImportantMessagesByReceiverIdPaginated" resultMap="messageReceiverResultMap">
        SELECT mr.RECEIVE_ID,
               mr.MESSAGE_ID,
               mr.RECEIVER_ID,
               mr.RECEIVER_TYPE,
               mr.READ_DATE,
               mr.INBOX_STATUS,
               mr.IS_DELETED,
               mr.IMPORTANT_YN,
               m.SUBJECT,
               u.NAME AS SENDER_NAME,
               m.SEND_DATE
        FROM GROUVY_MESSAGE_RECEIVE mr
                 JOIN
             GROUVY_MESSAGES m ON mr.MESSAGE_ID = m.MESSAGE_ID
                 JOIN
             GROUVY_USERS u ON m.SENDER_ID = u.USER_ID
        WHERE mr.RECEIVER_ID = #{receiverId}
          AND mr.IS_DELETED = 'N'
          AND mr.IMPORTANT_YN = 'Y'
          AND mr.INBOX_STATUS != 'RECALLED_BY_SENDER'
        ORDER BY
            m.SEND_DATE DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- countImportantMessages: 중요 쪽지함 총 항목 수 -->
    <select id="countImportantMessages" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM GROUVY_MESSAGE_RECEIVE mr
                 JOIN
             GROUVY_MESSAGES m ON mr.MESSAGE_ID = m.MESSAGE_ID
        WHERE mr.RECEIVER_ID = #{receiverId}
          AND mr.IS_DELETED = 'N'
          AND mr.IMPORTANT_YN = 'Y'
          AND mr.INBOX_STATUS != 'RECALLED_BY_SENDER'
    </select>

    <!-- findSentMessagesBySenderIdPaginated: 보낸 쪽지함 페이징 조회 -->
    <select id="findSentMessagesBySenderIdPaginated" resultMap="messageResultMap">
        SELECT
        ms.SEND_ID, <!-- Message VO의 sendId 필드에 매핑 -->
        m.MESSAGE_ID,
        m.SENDER_ID,
        m.SUBJECT,
        m.MESSAGE_CONTENT,
        m.SEND_DATE,
        m.RECALL_ABLE
        FROM
        GROUVY_MESSAGES m
        JOIN
        GROUVY_MESSAGE_SEND ms ON m.MESSAGE_ID = ms.MESSAGE_ID
        WHERE
        ms.SENDER_ID = #{senderId}
        AND ms.IS_DELETED = 'N'
        ORDER BY
        m.SEND_DATE DESC
        OFFSET #{offset} ROWS FETCH NEXT #{limit} ROWS ONLY
    </select>

    <!-- countTotalSentMessages: 보낸 쪽지함 총 항목 수 -->
    <select id="countTotalSentMessages" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM GROUVY_MESSAGE_SEND
        WHERE SENDER_ID = #{senderId}
          AND IS_DELETED = 'N'
    </select>

    <!-- findMessageDetailById: 쪽지 본문 상세 조회 -->
    <select id="findMessageDetailById" parameterType="long" resultMap="messageResultMap">
        SELECT
        m.MESSAGE_ID,
        m.SENDER_ID,
        m.SUBJECT,
        m.MESSAGE_CONTENT,
        m.SEND_DATE,
        m.RECALL_ABLE,
        ms.SEND_ID <!-- MessageSender의 sendId를 Message VO에 매핑 -->
        FROM
        GROUVY_MESSAGES m
        LEFT JOIN
        GROUVY_MESSAGE_SEND ms ON m.MESSAGE_ID = ms.MESSAGE_ID
        WHERE
        m.MESSAGE_ID = #{messageId}
    </select>

    <!-- findReceiverUserNamesByMessageIdAndType: 특정 쪽지의 TO/CC/BCC 수신자 이름 목록 조회 -->
    <select id="findReceiverUserNamesByMessageIdAndType" resultType="string">
        SELECT u.NAME
        FROM GROUVY_MESSAGE_RECEIVE mr
                 JOIN
             GROUVY_USERS u ON mr.RECEIVER_ID = u.USER_ID
        WHERE mr.MESSAGE_ID = #{messageId}
          AND mr.RECEIVER_TYPE = #{receiverType}
        ORDER BY u.NAME ASC
    </select>

    <!-- findAllReceiversByMessageId: 특정 쪽지의 모든 수신자 기록 조회 -->
    <select id="findAllReceiversByMessageId" parameterType="long" resultMap="messageReceiverResultMap">
        SELECT RECEIVE_ID,
               MESSAGE_ID,
               RECEIVER_ID,
               RECEIVER_TYPE,
               READ_DATE,
               INBOX_STATUS,
               IS_DELETED,
               IMPORTANT_YN
        FROM GROUVY_MESSAGE_RECEIVE
        WHERE MESSAGE_ID = #{messageId}
          AND IS_DELETED = 'N'
    </select>

    <!-- countUnreadReceiversByMessageId: 읽지 않은 수신자 수 조회 -->
    <select id="countUnreadReceiversByMessageId" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM GROUVY_MESSAGE_RECEIVE
        WHERE MESSAGE_ID = #{messageId}
          AND INBOX_STATUS = 'UNREAD'
          AND IS_DELETED = 'N'
    </select>

    <!-- countTotalReceiversByMessageId: 전체 수신자 수 조회 -->
    <select id="countTotalReceiversByMessageId" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM GROUVY_MESSAGE_RECEIVE
        WHERE MESSAGE_ID = #{messageId}
          AND IS_DELETED = 'N'
    </select>

    <!-- **쪽지 상태 변경 관련 쿼리** -->

    <!-- updateMessageReceiverReadDate: 받은 쪽지 읽음 처리 -->
    <update id="updateMessageReceiverReadDate">
        UPDATE GROUVY_MESSAGE_RECEIVE
        SET READ_DATE    = SYSDATE,
            INBOX_STATUS = 'READ'
        WHERE RECEIVE_ID = #{receiveId}
          AND INBOX_STATUS = 'UNREAD'
    </update>

    <!-- updateMessageReceiverIsDeleted: 받은 쪽지 삭제 처리 -->
    <update id="updateMessageReceiverIsDeleted">
        UPDATE GROUVY_MESSAGE_RECEIVE
        SET IS_DELETED = #{isDeleted}
        WHERE RECEIVE_ID = #{receiveId}
    </update>

    <!-- updateMessageSenderIsDeleted: 보낸 쪽지 삭제 처리 -->
    <update id="updateMessageSenderIsDeleted">
        UPDATE GROUVY_MESSAGE_SEND
        SET IS_DELETED = #{isDeleted}
        WHERE SEND_ID = #{sendId}
    </update>

    <!-- updateInboxStatusToRecalled: 받은 쪽지함 상태를 회수됨으로 변경 -->
    <update id="updateInboxStatusToRecalled">
        UPDATE GROUVY_MESSAGE_RECEIVE
        SET INBOX_STATUS = 'RECALLED_BY_SENDER'
        WHERE MESSAGE_ID = #{messageId}
          AND INBOX_STATUS = 'UNREAD'
          AND IS_DELETED = 'N'
    </update>

    <!-- updateMessageReceiverImportantYn: 받은 쪽지 중요 표시/해제 -->
    <update id="updateMessageReceiverImportantYn">
        UPDATE GROUVY_MESSAGE_RECEIVE
        SET IMPORTANT_YN = #{importantYn}
        WHERE RECEIVE_ID = #{receiveId}
    </update>

    <!-- countUnreadReceivedMessages: 읽지 않은 쪽지 수 조회 -->
    <select id="countUnreadReceivedMessages" parameterType="long" resultType="int">
        SELECT COUNT(*)
        FROM GROUVY_MESSAGE_RECEIVE
        WHERE RECEIVER_ID = #{receiverId}
          AND IS_DELETED = 'N'
          AND INBOX_STATUS = 'UNREAD'
    </select>

</mapper>